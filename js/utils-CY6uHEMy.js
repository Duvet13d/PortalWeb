import{r as e}from"./react-vendor-BlsGRQ4b.js";class t{constructor(){this.algorithm="AES-GCM",this.keyLength=256,this.ivLength=12}async deriveKey(e,t){const r=new TextEncoder,s=await crypto.subtle.importKey("raw",r.encode(e),"PBKDF2",!1,["deriveBits","deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:1e5,hash:"SHA-256"},s,{name:this.algorithm,length:this.keyLength},!1,["encrypt","decrypt"])}generateSalt(){return crypto.getRandomValues(new Uint8Array(16))}generateIV(){return crypto.getRandomValues(new Uint8Array(this.ivLength))}async encrypt(e,t){try{const r=new TextEncoder,s=this.generateSalt(),a=this.generateIV(),i=await this.deriveKey(t,s),o=await crypto.subtle.encrypt({name:this.algorithm,iv:a},i,r.encode(JSON.stringify(e))),n=new Uint8Array(s.length+a.length+o.byteLength);return n.set(s,0),n.set(a,s.length),n.set(new Uint8Array(o),s.length+a.length),btoa(String.fromCharCode(...n))}catch(r){throw new Error("Failed to encrypt data")}}async decrypt(e,t){try{const r=new Uint8Array(atob(e).split("").map(e=>e.charCodeAt(0))),s=r.slice(0,16),a=r.slice(16,16+this.ivLength),i=r.slice(16+this.ivLength),o=await this.deriveKey(t,s),n=await crypto.subtle.decrypt({name:this.algorithm,iv:a},o,i),c=new TextDecoder;return JSON.parse(c.decode(n))}catch(r){throw new Error("Failed to decrypt data - invalid password or corrupted data")}}}const r=new class{constructor(e={}){this.prefix=e.prefix||"homepage_",this.version=e.version||"1.0.0",this.encryption=new t,this.sensitiveKeys=new Set(e.sensitiveKeys||["spotify-tokens","api-keys","personal-notes","private-links"]),this.migrationHandlers=new Map,this.backupInterval=e.backupInterval||864e5,this.maxBackups=e.maxBackups||5,this.init()}async init(){await this.runMigrations(),this.setupAutoBackup(),this.cleanupOldBackups()}isSensitive(e){return this.sensitiveKeys.has(e)||e.includes("password")||e.includes("token")}getStorageKey(e){return`${this.prefix}${e}`}async set(e,t,r={}){try{const s=this.getStorageKey(e),a={version:this.version,timestamp:Date.now(),encrypted:!1,checksum:null};let i=t;if(this.isSensitive(e)&&(r.password||r.encrypt)){if(!r.password)throw new Error("Password required for sensitive data");i=await this.encryption.encrypt(t,r.password),a.encrypted=!0}a.checksum=await this.generateChecksum(JSON.stringify(t));const o={data:i,metadata:a};return localStorage.setItem(s,JSON.stringify(o)),!1!==r.backup&&await this.createBackup(e,t,a),!0}catch(s){throw s}}async get(e,t={}){try{const r=this.getStorageKey(e),s=localStorage.getItem(r);if(!s)return null;const a=JSON.parse(s),{data:i,metadata:o}=a;if(o.checksum&&!o.encrypted){if(await this.generateChecksum(JSON.stringify(i))!==o.checksum)return await this.restoreFromBackup(e,t)}if(o.encrypted){if(!t.password)throw new Error("Password required to decrypt sensitive data");return await this.encryption.decrypt(i,t.password)}return i}catch(r){if(!1!==t.fallbackToBackup)return await this.restoreFromBackup(e,t);throw r}}remove(e){try{const t=this.getStorageKey(e);return localStorage.removeItem(t),this.removeBackups(e),!0}catch(t){return!1}}clear(){try{return Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).forEach(e=>localStorage.removeItem(e)),this.clearAllBackups(),!0}catch(e){return!1}}async generateChecksum(e){const t=(new TextEncoder).encode(e),r=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(r)).map(e=>e.toString(16).padStart(2,"0")).join("")}async exportData(e={}){try{const r={version:this.version,timestamp:Date.now(),data:{},metadata:{encrypted:e.encrypt||!1,includeBackups:e.includeBackups||!1}},s=Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).map(e=>e.replace(this.prefix,""));for(const a of s)try{const t=await this.get(a,{password:e.password,fallbackToBackup:!1});null!==t&&(r.data[a]=t)}catch(t){r.data[a]={error:t.message}}if(e.includeBackups&&(r.backups=await this.exportBackups()),e.encrypt&&e.password){const t=await this.encryption.encrypt(r,e.password);return{encrypted:!0,version:this.version,data:t}}return r}catch(t){throw t}}async importData(e,t={}){try{let s=e;if(e.encrypted&&t.password&&(s=await this.encryption.decrypt(e.data,t.password)),!s.version||!s.data)throw new Error("Invalid import data format");if(s.version!==this.version&&!t.force)throw new Error(`Version mismatch: expected ${this.version}, got ${s.version}`);const a={success:[],failed:[],skipped:[]};for(const[e,i]of Object.entries(s.data))try{if(i.error){a.skipped.push({key:e,reason:"Export error: "+i.error});continue}if(!t.overwrite&&await this.get(e,{fallbackToBackup:!1})){a.skipped.push({key:e,reason:"Key already exists"});continue}await this.set(e,i,{password:t.password,backup:!1!==t.createBackup}),a.success.push(e)}catch(r){a.failed.push({key:e,error:r.message})}return s.backups&&t.importBackups&&await this.importBackups(s.backups),a}catch(r){throw r}}async createBackup(e,t,r){try{const s=`${this.prefix}backup_${e}_${Date.now()}`,a={originalKey:e,data:t,metadata:r,backupTimestamp:Date.now()};localStorage.setItem(s,JSON.stringify(a)),await this.cleanupKeyBackups(e)}catch(s){}}async restoreFromBackup(e,t={}){try{const t=this.getKeyBackups(e);if(0===t.length)return null;return t[0].data}catch(r){return null}}getKeyBackups(e){const t=`${this.prefix}backup_${e}_`;return Object.keys(localStorage).filter(e=>e.startsWith(t)).map(e=>{try{return JSON.parse(localStorage.getItem(e))}catch{return null}}).filter(e=>null!==e).sort((e,t)=>t.backupTimestamp-e.backupTimestamp)}async cleanupKeyBackups(e){this.getKeyBackups(e);const t=Object.keys(localStorage).filter(t=>t.startsWith(`${this.prefix}backup_${e}_`)).sort();if(t.length>this.maxBackups){t.slice(0,t.length-this.maxBackups).forEach(e=>localStorage.removeItem(e))}}removeBackups(e){const t=`${this.prefix}backup_${e}_`;Object.keys(localStorage).filter(e=>e.startsWith(t)).forEach(e=>localStorage.removeItem(e))}clearAllBackups(){const e=`${this.prefix}backup_`;Object.keys(localStorage).filter(t=>t.startsWith(e)).forEach(e=>localStorage.removeItem(e))}async exportBackups(){const e=`${this.prefix}backup_`,t={};return Object.keys(localStorage).filter(t=>t.startsWith(e)).forEach(e=>{try{t[e]=JSON.parse(localStorage.getItem(e))}catch(r){}}),t}async importBackups(e){for(const[r,s]of Object.entries(e))try{localStorage.setItem(r,JSON.stringify(s))}catch(t){}}setupAutoBackup(){setInterval(async()=>{try{const e=await this.exportData({includeBackups:!1}),t=`${this.prefix}auto_backup_${Date.now()}`;localStorage.setItem(t,JSON.stringify(e)),this.cleanupAutoBackups()}catch(e){}},this.backupInterval)}cleanupAutoBackups(){const e=`${this.prefix}auto_backup_`,t=Object.keys(localStorage).filter(t=>t.startsWith(e)).sort();if(t.length>this.maxBackups){t.slice(0,t.length-this.maxBackups).forEach(e=>localStorage.removeItem(e))}}cleanupOldBackups(){const e=Date.now();Object.keys(localStorage).filter(e=>e.startsWith(`${this.prefix}backup_`)).forEach(t=>{try{const r=JSON.parse(localStorage.getItem(t));r.backupTimestamp&&e-r.backupTimestamp>6048e5&&localStorage.removeItem(t)}catch(r){localStorage.removeItem(t)}})}addMigration(e,t,r){const s=`${e}->${t}`;this.migrationHandlers.set(s,r)}async runMigrations(){try{const e=this.getCurrentStorageVersion();if(e===this.version)return;for(const[t,r]of this.migrationHandlers){const[s,a]=t.split("->");this.shouldRunMigration(e,s,a)&&await r(this)}this.setStorageVersion(this.version)}catch(e){throw e}}getCurrentStorageVersion(){try{const e=`${this.prefix}version`;return localStorage.getItem(e)||"0.0.0"}catch{return"0.0.0"}}setStorageVersion(e){const t=`${this.prefix}version`;localStorage.setItem(t,e)}shouldRunMigration(e,t,r){return e===t||e<r&&e>=t}getStorageStats(){const e={totalKeys:0,encryptedKeys:0,totalSize:0,backupCount:0,oldestBackup:null,newestBackup:null};return Object.keys(localStorage).forEach(t=>{var r;if(t.startsWith(this.prefix)){e.totalKeys++;try{const s=localStorage.getItem(t);if(e.totalSize+=s.length,t.includes("backup_")){e.backupCount++;const t=JSON.parse(s);t.backupTimestamp&&((!e.oldestBackup||t.backupTimestamp<e.oldestBackup)&&(e.oldestBackup=t.backupTimestamp),(!e.newestBackup||t.backupTimestamp>e.newestBackup)&&(e.newestBackup=t.backupTimestamp))}else{(null==(r=JSON.parse(s).metadata)?void 0:r.encrypted)&&e.encryptedKeys++}}catch(s){}}}),e}}({prefix:"homepage_enhanced_",version:"1.0.0",sensitiveKeys:["spotify-tokens","api-keys","weather-api-key","personal-notes","private-links","user-credentials"]});r.addMigration("0.0.0","1.0.0",async e=>{const t=["homepage-widgets","homepage-theme","homepage-notes","custom-links"];for(const s of t){const t=localStorage.getItem(s);if(t)try{const r=JSON.parse(t),a=s.replace("homepage-","").replace("-","_");await e.set(a,r,{backup:!0})}catch(r){}}});const s={trapFocus:e=>{const t=e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),r=t[0],s=t[t.length-1],a=e=>{"Tab"===e.key&&(e.shiftKey?document.activeElement===r&&(e.preventDefault(),s.focus()):document.activeElement===s&&(e.preventDefault(),r.focus()))};return e.addEventListener("keydown",a),r&&r.focus(),()=>{e.removeEventListener("keydown",a)}},saveFocus:()=>document.activeElement,restoreFocus:e=>{e&&e.focus&&e.focus()},focusFirstError:e=>{const t=e.querySelector('[aria-invalid="true"], .error');t&&t.focus()}},a={announce:(e,t="polite")=>{const r=document.createElement("div");r.setAttribute("aria-live",t),r.setAttribute("aria-atomic","true"),r.className="sr-only",r.textContent=e,document.body.appendChild(r),setTimeout(()=>{document.body.removeChild(r)},1e3)},setExpanded:(e,t)=>{e.setAttribute("aria-expanded",t.toString())},setPressed:(e,t)=>{e.setAttribute("aria-pressed",t.toString())},setSelected:(e,t)=>{e.setAttribute("aria-selected",t.toString())},setInvalid:(e,t,r="")=>{if(e.setAttribute("aria-invalid",t.toString()),t&&r){const t=`${e.id||"field"}-error`;let s=document.getElementById(t);s||(s=document.createElement("div"),s.id=t,s.className="sr-only",e.parentNode.appendChild(s)),s.textContent=r,e.setAttribute("aria-describedby",t)}else{e.removeAttribute("aria-describedby");const t=document.getElementById(`${e.id||"field"}-error`);t&&t.remove()}}},i={handleArrowNavigation:(e,t,r,s)=>{let a=r;switch(e.key){case"ArrowDown":e.preventDefault(),a=r<t.length-1?r+1:0;break;case"ArrowUp":e.preventDefault(),a=r>0?r-1:t.length-1;break;case"Home":e.preventDefault(),a=0;break;case"End":e.preventDefault(),a=t.length-1;break;default:return}s(a),t[a]&&t[a].focus&&t[a].focus()},handleActivation:(e,t)=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),t())}},o={createSkipLink:(e,t="Skip to main content")=>{const r=document.createElement("a");return r.href=`#${e}`,r.textContent=t,r.className="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 focus:z-50 focus:px-4 focus:py-2 focus:bg-accent-1 focus:text-white focus:rounded-lg focus:no-underline",document.body.insertBefore(r,document.body.firstChild),r}},n=()=>{const[t,r]=e.useState(navigator.onLine),[s,a]=e.useState(!1);return e.useEffect(()=>{const e=()=>{r(!0),s&&(window.dispatchEvent(new CustomEvent("app:reconnected")),a(!1))},t=()=>{r(!1),a(!0),window.dispatchEvent(new CustomEvent("app:disconnected"))};return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}},[s]),{isOnline:t,wasOffline:s}};new class{constructor(e={}){this.retryAttempts=e.retryAttempts||3,this.retryDelay=e.retryDelay||1e3,this.cacheTimeout=e.cacheTimeout||3e5,this.enableCache=!1!==e.enableCache}async fetch(e,t={}){const r=this.getCacheKey(e,t);if(navigator.onLine)try{const s=await this.fetchWithRetry(e,t);return s.ok&&this.enableCache&&await this.cacheResponse(r,s.clone()),s}catch(a){return await this.getCachedResponse(r)||this.createOfflineResponse()}const s=await this.getCachedResponse(r);return s||this.createOfflineResponse()}async fetchWithRetry(e,t,r=1){try{const r=new AbortController,s=setTimeout(()=>r.abort(),1e4),a=await fetch(e,{...t,signal:r.signal});if(clearTimeout(s),!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);return a}catch(s){if(r<this.retryAttempts)return await this.delay(this.retryDelay*r),this.fetchWithRetry(e,t,r+1);throw s}}getCacheKey(e,t){const r=t.method||"GET",s=t.body?JSON.stringify(t.body):"";return`fetch_cache_${r}_${e}_${btoa(s).slice(0,10)}`}async cacheResponse(e,t){try{const r={data:await t.text(),headers:Object.fromEntries(t.headers.entries()),status:t.status,statusText:t.statusText,timestamp:Date.now()};localStorage.setItem(e,JSON.stringify(r))}catch(r){}}async getCachedResponse(e){try{const t=localStorage.getItem(e);if(!t)return null;const r=JSON.parse(t);return Date.now()-r.timestamp>this.cacheTimeout?(localStorage.removeItem(e),null):new Response(r.data,{status:r.status,statusText:r.statusText,headers:new Headers(r.headers)})}catch(t){return null}}createOfflineResponse(){return new Response(JSON.stringify({error:"offline",message:"No network connection available"}),{status:503,statusText:"Service Unavailable",headers:new Headers({"Content-Type":"application/json"})})}delay(e){return new Promise(t=>setTimeout(t,e))}};const c=new class{constructor(e="offline_"){this.prefix=e}set(e,t,r=36e5){try{const s={data:t,timestamp:Date.now(),ttl:r};return localStorage.setItem(this.prefix+e,JSON.stringify(s)),!0}catch(s){return!1}}get(e){try{const t=localStorage.getItem(this.prefix+e);if(!t)return null;const r=JSON.parse(t);return Date.now()-r.timestamp>r.ttl?(this.remove(e),null):r.data}catch(t){return null}}remove(e){try{return localStorage.removeItem(this.prefix+e),!0}catch(t){return!1}}clear(){try{return Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).forEach(e=>localStorage.removeItem(e)),!0}catch(e){return!1}}getAll(){try{const e={};return Object.keys(localStorage).filter(e=>e.startsWith(this.prefix)).forEach(t=>{const r=t.replace(this.prefix,""),s=this.get(r);null!==s&&(e[r]=s)}),e}catch(e){return{}}}}("homepage_offline_");new class{constructor(){this.isOfflineMode=!1,this.offlineData=new Map,this.listeners=new Set,this.init()}init(){window.addEventListener("online",()=>{this.setOfflineMode(!1),this.notifyListeners("online")}),window.addEventListener("offline",()=>{this.setOfflineMode(!0),this.notifyListeners("offline")}),this.setOfflineMode(!navigator.onLine)}setOfflineMode(e){this.isOfflineMode=e,document.body.classList.toggle("offline-mode",e)}addListener(e){return this.listeners.add(e),()=>this.listeners.delete(e)}notifyListeners(e){this.listeners.forEach(t=>t(e,this.isOfflineMode))}storeOfflineData(e,t){this.offlineData.set(e,{data:t,timestamp:Date.now()})}getOfflineData(e){var t;return null==(t=this.offlineData.get(e))?void 0:t.data}clearExpiredData(e=36e5){const t=Date.now();for(const[r,s]of this.offlineData.entries())t-s.timestamp>e&&this.offlineData.delete(r)}};const l={STANDARD:{attempts:3,delay:1e3,backoff:2}},u=async(e,t=l.STANDARD)=>{const{attempts:r,delay:s,backoff:a}=t;let i;for(let n=1;n<=r;n++)try{return await e(n)}catch(o){if(i=o,p(o))throw o;if(n<r){const e=s*Math.pow(a,n-1);await h(e)}}throw i};new class{constructor(e={}){this.queue=[],this.processing=!1,this.maxConcurrent=e.maxConcurrent||3,this.defaultConfig=e.defaultConfig||l.STANDARD}add(e,t=this.defaultConfig){return new Promise((r,s)=>{this.queue.push({operation:e,config:t,resolve:r,reject:s,id:Date.now()+Math.random()}),this.process()})}async process(){if(this.processing||0===this.queue.length)return;this.processing=!0;const e=[];for(;this.queue.length>0&&e.length<this.maxConcurrent;){const t=this.queue.shift();e.push(this.processItem(t))}await Promise.allSettled(e),this.processing=!1,this.queue.length>0&&this.process()}async processItem(e){try{const t=await u(e.operation,e.config);e.resolve(t)}catch(t){e.reject(t)}}clear(){this.queue.forEach(e=>{e.reject(new Error("Queue cleared"))}),this.queue=[]}size(){return this.queue.length}};const h=e=>new Promise(t=>setTimeout(t,e)),p=e=>!!["AbortError","TypeError","SyntaxError","ReferenceError"].includes(e.name)||e.status>=400&&e.status<500&&![408,429].includes(e.status),d="network_error",m="timeout",f="server_error",g="rate_limited",y="unauthorized",w="not_found",k="offline";const v=new class{constructor(){this.errorCounts=new Map,this.lastErrors=new Map,this.circuitBreakers=new Map}async handleAPICall(e,t={}){const{cacheKey:r,fallbackData:s,retryConfig:a=l.STANDARD,enableCircuitBreaker:i=!0,notifyUser:o=!0}=t;try{if(i&&this.isCircuitOpen(r))throw new Error("Circuit breaker is open");const t=await u(e,a);return this.resetErrorCount(r),t}catch(n){if(this.trackError(r,n),r){const e=c.get(r);if(e)return this.createCachedResponse(e)}if(s)return this.createFallbackResponse(s);throw o&&this.notifyUser(n,r),n}}trackError(e,t){if(!e)return;const r=this.errorCounts.get(e)||0;this.errorCounts.set(e,r+1),this.lastErrors.set(e,{error:t,timestamp:Date.now(),type:this.categorizeError(t)}),r>=4&&this.circuitBreakers.set(e,{isOpen:!0,openedAt:Date.now(),resetTimeout:6e4})}resetErrorCount(e){e&&(this.errorCounts.delete(e),this.circuitBreakers.delete(e))}isCircuitOpen(e){if(!e)return!1;const t=this.circuitBreakers.get(e);return!(!t||!t.isOpen)&&(!(Date.now()-t.openedAt>t.resetTimeout)||(this.circuitBreakers.delete(e),!1))}categorizeError(e){var t,r;if(!navigator.onLine)return k;if("AbortError"===e.name)return m;if(null==(t=e.message)?void 0:t.includes("timeout"))return m;const s=e.status||(null==(r=e.response)?void 0:r.status);return s>=500?f:429===s?g:401===s||403===s?y:404===s?w:d}createCachedResponse(e){return new Response(JSON.stringify(e),{status:200,statusText:"OK (Cached)",headers:new Headers({"Content-Type":"application/json","X-Cached-Response":"true","X-Cache-Source":"offline-storage"})})}createFallbackResponse(e){return new Response(JSON.stringify(e),{status:200,statusText:"OK (Fallback)",headers:new Headers({"Content-Type":"application/json","X-Fallback-Response":"true"})})}notifyUser(e,t){const r=this.categorizeError(e),s=this.getErrorMessage(r,t);"Notification"in window&&"granted"===Notification.permission&&new Notification("API Error",{body:s,icon:"/favi.svg",tag:`api-error-${t}`,silent:!0}),window.dispatchEvent(new CustomEvent("api:error",{detail:{error:e,apiName:t,errorType:r,message:s}}))}getErrorMessage(e,t="Service"){return{[k]:`${t} is unavailable while offline. Using cached data.`,[m]:`${t} is taking too long to respond. Please try again.`,[f]:`${t} is experiencing issues. Using cached data.`,[g]:`${t} rate limit exceeded. Please wait before trying again.`,[y]:`${t} access denied. Please check your credentials.`,[w]:`${t} endpoint not found.`,[d]:`Network error accessing ${t}. Using cached data.`}[e]||`${t} is currently unavailable.`}getErrorStats(){const e={};for(const[t,r]of this.errorCounts.entries()){const s=this.lastErrors.get(t),a=this.circuitBreakers.get(t);e[t]={errorCount:r,lastError:s?{type:s.type,message:s.error.message,timestamp:s.timestamp}:null,circuitBreakerOpen:(null==a?void 0:a.isOpen)||!1}}return e}};const S=new class{constructor(){this.notifications=new Map,this.maxNotifications=5,this.notificationTimeout=5e3}notify(e,t,r){const s=`${e}-${t}-${Date.now()}`,a=`${e}-${t}`;if(this.notifications.has(a))return;const i={id:s,apiName:e,errorType:t,message:r,timestamp:Date.now()};if(this.notifications.set(a,i),window.dispatchEvent(new CustomEvent("api:notification",{detail:i})),setTimeout(()=>{this.notifications.delete(a),window.dispatchEvent(new CustomEvent("api:notification:remove",{detail:{id:s}}))},this.notificationTimeout),this.notifications.size>this.maxNotifications){const e=this.notifications.keys().next().value;this.notifications.delete(e)}}clearAll(){this.notifications.clear(),window.dispatchEvent(new CustomEvent("api:notifications:clear"))}getNotifications(){return Array.from(this.notifications.values())}};const b=new class{constructor(){this.migrationStatus={completed:!1,errors:[],migrated:[],skipped:[]}}async checkMigrationNeeded(){const e=["homepage-widgets","homepage-theme","homepage-notes","custom-links","notes-settings"].some(e=>null!==localStorage.getItem(e)),t=await r.get("migration_completed");return e&&!t}async performMigration(e={}){try{const s=[{oldKey:"homepage-widgets",newKey:"widgets",transform:e=>e},{oldKey:"homepage-theme",newKey:"theme",transform:e=>e},{oldKey:"homepage-notes",newKey:"personal_notes",transform:e=>e,sensitive:!0},{oldKey:"custom-links",newKey:"custom_links",transform:e=>e},{oldKey:"notes-settings",newKey:"notes_settings",transform:e=>e}];for(const a of s)try{const t=localStorage.getItem(a.oldKey);if(t){const s=JSON.parse(t),i=a.transform(s);await r.set(a.newKey,i,{backup:!0,encrypt:a.sensitive&&e.encryptSensitive}),this.migrationStatus.migrated.push({from:a.oldKey,to:a.newKey,encrypted:a.sensitive&&e.encryptSensitive}),e.removeOldData&&localStorage.removeItem(a.oldKey)}else this.migrationStatus.skipped.push({key:a.oldKey,reason:"No data found"})}catch(t){this.migrationStatus.errors.push({key:a.oldKey,error:t.message})}return await r.set("migration_completed",{timestamp:Date.now(),version:"1.0.0",status:this.migrationStatus}),this.migrationStatus.completed=!0,this.migrationStatus}catch(t){throw t}}getMigrationStatus(){return this.migrationStatus}async rollbackMigration(){try{const e=await r.get("migration_completed");if(!e)throw new Error("No migration record found");const t=e.status.migrated.map(e=>e.to);for(const s of t)r.remove(s);return r.remove("migration_completed"),!0}catch(e){throw e}}async cleanupOldData(){try{const e=await r.get("migration_completed");if(!e)throw new Error("No migration record found");const t=e.status.migrated.map(e=>e.from);for(const r of t)localStorage.removeItem(r);return!0}catch(e){throw e}}};const E=new class{constructor(){this.currentVersion="1.0.0",this.githubRepo="yourusername/PortalWeb",this.checkInterval=864e5,this.lastCheckKey="personal-portal-last-update-check",this.updateAvailableKey="personal-portal-update-available"}async checkForUpdates(e=!1){try{if(!this.githubRepo||"yourusername/PortalWeb"===this.githubRepo)return{available:!1,error:"GitHub repository not configured",lastChecked:Date.now()};const t=localStorage.getItem(this.lastCheckKey),r=Date.now();if(!e&&t&&r-parseInt(t)<this.checkInterval)return this.getStoredUpdateInfo();const s=await fetch(`https://api.github.com/repos/${this.githubRepo}/releases/latest`);if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);const a=await s.json(),i=a.tag_name.replace(/^v/,"");localStorage.setItem(this.lastCheckKey,r.toString());const o={available:this.compareVersions(this.currentVersion,i)<0,currentVersion:this.currentVersion,latestVersion:i,releaseUrl:a.html_url,releaseNotes:a.body,publishedAt:a.published_at,lastChecked:r};return localStorage.setItem(this.updateAvailableKey,JSON.stringify(o)),o}catch(t){return{available:!1,error:t.message,lastChecked:Date.now()}}}getStoredUpdateInfo(){try{const e=localStorage.getItem(this.updateAvailableKey);return e?JSON.parse(e):{available:!1}}catch(e){return{available:!1}}}compareVersions(e,t){const r=e.split(".").map(Number),s=t.split(".").map(Number),a=Math.max(r.length,s.length);for(let i=0;i<a;i++){const e=r[i]||0,t=s[i]||0;if(e<t)return-1;if(e>t)return 1}return 0}initAutoCheck(){this.checkForUpdates(),setInterval(()=>{this.checkForUpdates()},this.checkInterval),document.addEventListener("visibilitychange",()=>{if(!document.hidden){const e=localStorage.getItem(this.lastCheckKey),t=Date.now();(!e||t-parseInt(e)>216e5)&&this.checkForUpdates()}})}dismissUpdate(){const e=this.getStoredUpdateInfo();e.dismissed=!0,e.dismissedAt=Date.now(),localStorage.setItem(this.updateAvailableKey,JSON.stringify(e))}shouldShowUpdateNotification(){const e=this.getStoredUpdateInfo();if(!e.available)return!1;if(e.dismissed){const t=Date.now()-6048e5;return e.dismissedAt<t}return!0}getUpdateNotificationData(){const e=this.getStoredUpdateInfo();return this.shouldShowUpdateNotification()?{message:`Personal Portal v${e.latestVersion} is available!`,currentVersion:e.currentVersion,latestVersion:e.latestVersion,releaseUrl:e.releaseUrl,releaseNotes:e.releaseNotes,publishedAt:new Date(e.publishedAt).toLocaleDateString()}:null}async refreshApplication(){try{if("serviceWorker"in navigator&&"caches"in window){const e=await caches.keys();await Promise.all(e.map(e=>caches.delete(e)))}window.location.reload(!0)}catch(e){window.location.reload()}}};export{a,S as b,E as c,r as e,s as f,v as g,i as k,b as m,o as s,n as u};
